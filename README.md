# Azure Honeynet & SOC Project: Cyber Attacks in Real Time
![Cloud Honeynet / SOC](https://i.imgur.com/yMxqsuG.png)

## Introduction

In this project, I create a mini honeynet, emulating real-world traffic by luring global attackers via Microsoft Azure. The primary objective of this undertaking is to illustrate optimal security measures, effective incident response strategies, and the impact of fortifying your system. This will be achieved by deliberately deploying virtual machines lacking safeguards against the public internet, enticing attackers into our environment. Subsequently, by incorporating log sources into the Log Analytics Workspace, Microsoft Sentinel will be utilized to generate attack maps, alerts, and incidents. The intention is to present metrics reflecting the state of the environment before and after fortification, derived from incidents recorded during the 24-hour monitoring period.

## Azure Components Utilized

- Azure Virtual Network (VNet)
- Azure Network Security Group (NSG)
- Virtual Machines (2x Windows, 1x Linux)
- Log Analytics Workspace with Kusto Query Language (KQL) Queries
- Azure Key Vault 
- Azure Storage Account 
- Microsoft Sentinel 
- Microsoft Defender for Cloud 

## Architecture Before Hardening
![Architecture Diagram](https://i.imgur.com/c2E0AtK.png)

 - During the initial phase of the project labeled as "BEFORE," all resources were deployed with the anticipation of drawing attention from the public internet. The Virtual Machines were configured with both their Network Security Groups (NSGs) and built-in firewalls wide open, granting unrestricted access from any source. Furthermore, other resources like storage accounts and databases were deployed with public endpoints exposed to the internet, without incorporating any Private Endpoints for enhanced security. Subsequently, these machines were left accessible to the public for a 24-hour period, aimed at generating the attack maps mentioned earlier.
 <br />
 
 <b>This attack map showcases the number of incidents generated by leaving the Network Security Group (NSG) open. </b>
 
   ![NSG Allowed Inbound Malicious Flows](https://i.imgur.com/bNOtiKt.png)<br>

 <br />
 <br />
 
 <b>This attack map highlights the incidents for syslog authentication failures experienced by the Linux server. </b>
 
![Linux Syslog Auth Failures](https://i.imgur.com/nFR0Ehf.png)<br>

 <br />
 <br />
 
 <b>This attack map showcases RDP and SMB failures against the Window machine.</b>
 
![Windows RDP/SMB Auth Failures](https://i.imgur.com/4bylhdW.png)<br>

 <br />
 <br />
 
 <b>This attack map showcases failures against the MSSQL server.</b>
 
![MSSQL](https://i.imgur.com/TYIlNVI.png)<br>

 <br />
 <br />
 
 ## After Hardening Measures and Security Controls

In the "AFTER" phase, I implemented security enhancements and controls based on the incidents generated during the initial 24-hour capture in the "BEFORE" stage. The objective was to fortify the environment and enhance its security against potential attackers.<br /> 
These improvements included:

- <b>Network Security Groups (NSGs)</b>: I hardened the NSGs by only allowing my own public IP address to come thrugh otherwise all other traffic would be blocked by the new parameteres created.

- <b>Built-in Firewalls</b>: I set up the built-in firewalls on my virtual machines to block access from unauthorized users.

- <b>Private Endpoints</b>: For other Azure resources, I substituted public endpoints with Private Endpoints. This guaranteed that access to sensitive resources, such as storage accounts and databases, was restricted solely to the virtual network.

## Attack Maps After Hardening / Security Controls

<br />

```All map queries actually returned no results due to no instances of malicious activity for the 24 hour period after hardening.```

 <br />
 
## Metrics Before Hardening / Security Controls

The following table shows the metrics we measured in our insecure environment for 24 hours:<br/>
Start Time 2024-01-06 05:03 PM<br/>
Stop Time 2024-01-078= 05:03 PM

| Metric                   | Count
| ------------------------ | -----
| SecurityEvent (Windows VM)            | 26,835
| Syslog (Linux VM)                   | 7716
| SecurityAlert (Microsoft Defender for Cloud            | 3
| SecurityIncident (Sentinel Incidents)        | 345
| NSG Inbound Malicious Flows Allowed | 3050



## Metrics After Hardening / Security Controls

The following table shows the metrics we measured in our secure environment for 24 hours:<br/>
Start Time 2023-05-04 4:25 PM<br/>
Stop Time	2023-05-05 4:25 PM


| Metric                   | Count
| ------------------------ | -----
| SecurityEvent (Windows VM)            | 2364
| Syslog (Linux VM)                   | 24
| SecurityAlert (Microsoft Defender for Cloud            | 0
| SecurityIncident (Sentinel Incidents)        | 0
| NSG Inbound Malicious Flows Allowed | 0

<br/>


## Utilizing NIST 800.61r2 Computer Incident Handling Guide

For each simulated attack I practiced incident responses following NIST SP 800-61 r2.

![NIST 800.61](https://i.imgur.com/VUTWhEe.png)

Every organization will have specific incident response policies that must be adhered to. This scenario is merely a step-by-step guide outlining potential actions to be taken upon the detection of malware on a workstation.  

#### Preparation

- The Azure laboratory was established to integrate all logs into the Log Analytics Workspace. Configurations for Sentinel and Defender were implemented, and alert rules were established.

#### Detection & Analysis

- A workstation has been flagged with the presence of malware, posing a threat to the system and data's confidentiality, integrity, or availability.
- The alert has been assigned to an owner, with severity set to "High" and status marked as "Active."
- The primary user account of the affected system and all related systems have been identified.
- A comprehensive system scan was executed using current antivirus software to pinpoint and identify the malware.
- The alert's legitimacy was confirmed, classifying it as a "True Positive."
- Notifications were dispatched to relevant personnel in accordance with the organization's communication policies.

#### Containment, Eradication & Recovery

- The infected system, along with any other systems affected by the malware, underwent quarantine measures.
- In instances where the malware proved resistant to removal or inflicted damage on the system, a shutdown and disconnection from the network would have been implemented.
- Adhering to organizational policies, options for remediation included restoring the affected systems to a known clean state, such as employing a system image or performing a clean installation of the operating system and applications. Alternatively, an up-to-date antivirus solution could be employed to cleanse the systems.

#### Post-Incident Activity

- In this simulated scenario, an employee downloaded a game that harbored malware.
- Comprehensive information was collected and analyzed to ascertain the root cause, assess the scope of damage, and evaluate the efficacy of the response.
- A report detailing the incident was distributed to all stakeholders.
- Corrective actions were enacted to address and rectify the root cause.
- Subsequently, a review of lessons learned from the incident was conducted.

<br />

## Conclusion

In this project, a small-scale honeynet was set up in Microsoft Azure, and log sources were integrated into a Log Analytics workspace. Microsoft Sentinel was utilized to generate alerts and incidents based on the processed logs. Furthermore, metrics were assessed in the initially insecure environment, both before and after the implementation of security controls. The substantial decrease in security events and incidents post the application of security measures underscores their efficacy in fortifying the environment.

It's important to note that if the network's resources were heavily utilized by regular users, there could have been a likelihood of generating more security events and alerts in the 24-hour period following the implementation of security controls.
